# LeadVertex process плагин
`\Leadvertex\Plugin\Components\Process` - компонент, предназначенный для хранения и предоставления информации
о текущем состоянии процесса на основе базовой модели БД
[из plugin-component-db](https://github.com/leadvertex/plugin-component-db "из plugin-component-db")
и принимает id процесса в конструктор.

## Установка
```shell script
composer require leadvertex/plugin-component-process
```

## Использование
Например, вы можете создать новый процесс следующим образом:
```php
<?php
require 'vendor/autoload.php';

use Leadvertex\Plugin\Components\Process\Process;

$process = new Process($id);
$process->save();

$process->initialize(5);
$process->save();
...

$process->handle();
$process->handle();
$process->handle();
$process->save();
...

$process->skip();
$process->save;
...

$process->addError(new Error('Error message', $entityId));
$process->save();
...

$result = $process->finish(true);
$process->save();
```

Обратите внимание, что вам нужно использовать метод `save()` для сохранения актуальной информации в БД.

### Состояния процесса
Каждый `Process` имеет свойство `state` указывающее на текущее состояние обработки:
- `Process::STATE_STATE_SCHEDULED` - присваивается при создании процесса. Это состояние указывает на то, что процесс был поставлен в очередь на обработку.
- `Process::STATE_PROCESSING` - присваивается при инициализации процесса. Это состояние указывает на то, что выполнение процесса было начато.
- `Process::STATE_POST_PROCESSING` - присваивается вручную. С его помощью можно указать завершение основного процесса и начало дополнительных действий с результатом обработки.
- `Process::STATE_ENDED` - присваивается, когда вы завершаете процесс или прекращаете его работу. Это состояние указывает на то, что процесс был завершен.

Чтобы получить текущее состояние процесса, вы можете использовать метод `getState()`:
```php
$state = $process->getState();
```
Для установки состояния вы можете использовать метод `setState`. Обратите внимание, что вы можете использовать только константы `Process`:
```php
$process->setState(Process::STATE_POST_PROCESSING); // OK
$process->setState('new_state'); // Неверно
```

### Инициализация
Метод `initialize()` предназначен для указания количества обрабатываемых объектов.\
Он принимает значение количества объектов, которые будут обработаны. Число может быть `null` для случаев, когда вы не можете определить
его точное значение.\
Обратите внимание, что вы должны инициализировать процесс, прежде чем сможете использовать его методы `handle()`,` skip()` и `finish()`.\
Вы можете проверить, был ли процесс уже инициализирован с помощью метода `isInitialized()`.


### Обработка
Метод `handle()` предназначен для увеличения количества успешно обработанных объектов.\
Вы можете получить текущее количество обработанных объектов с помощью метода `getHandledCount()`.

### Пропуск обработки
Метод `skip()` предназначен для пропуска обработки текущего объекта. Вы можете использовать его в тех случаях, когда ваш объект становится
недоступен во время обработки.\
Вы можете получить текущее количество пропущенных объектов с помощью метода `getSkippedCount()`.

### Добавление ошибок обработки
Метод `addError()` предназначен для использования при возникновении ошибки обработки сущности.\
Он принимает экземпляр `\Leadvertex\Plugin\Components\Process\Components\Error` в себя. Вы можете использовать это так:
```php
$process->addError(new Error('Entity handle is failed', $entityId));
$process->save();

$errors = $process->getLastErrors();
```
Вы можете получить список из 20 последних ошибок с помощью метода `getLastErrors()`.

### Прекращение обработки при исключении
Метод `terminate()` предназначен для остановки выполнения процесса из-за фатальной ошибки.\
Он принимает экземпляр `\Leadvertex\Plugin\Components\Process\Components\Error` в себя,
добавляет ошибку аналогично методу `addError()`, помечает обработку всех оставшихся объектов завершенной с ошибкой,
устанавливает результат выполнения процесса как `false` и устанавливает свойство` updatedAt` модели в качестве текущего DateTime.\
Вы можете получить результат выполнения процесса с помощью метода `getResult()`.\
Вы можете использовать этот метод следующим образом:
```php
$process->terminate(new Error('Fatal error', $entityId));
$process->save();

$errors = $process->getLastErrors();
```

### Успешное завершение работы
Метод `finish()` предназначен для использования, когда ваш процесс корректно завершил свою работу.\
Он принимает результат в себя, который может быть одним из 3 следующих типов:
1. `bool` - используется, когда вам нужно вернуть окончательный статус выполнения вашего процесса.
2. `int` - используется, когда вам нужно вернуть количество обработанных сущностей.
3. `string` - используется, когда вам нужно вернуть URI в результате.

Также он устанавливает результат выполнения процесса в качестве принятого значения
и устанавливает свойство `updatedAt` как текущий DateTime.

### JsonSerializable
Process реализует встроенный интерфейс `jsonSerializable`, что означает, что вы можете получить информацию о процессе в виде сериализованного json, просто используя
json_encode для обработки экземпляра.
Например, вы можете использовать его так:
```php
$response = json_encode($process);
```